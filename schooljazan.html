<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج متابعة خريطة نواتج التعلم - مدرسة الصوارمة</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#07A869',
                        'secondary': '#3D7EB9',
                        'accent': '#0DA9A6',
                        'dark': '#15445A',
                        'gold': '#C1B48A',
                        'custom-gray': '#C2C1C1'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
        
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-dark text-white p-4 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-2xl font-bold text-center">برنامج متابعة خريطة نواتج التعلم</h1>
            <p class="text-center text-lg mt-2">مدرسة ابتدائية ومتوسطة الصوارمة - جازان</p>
            <div class="text-center mt-2">
                <span id="current-date" class="text-sm bg-gold text-dark px-3 py-1 rounded"></span>
                <span id="current-time" class="text-sm bg-secondary px-3 py-1 rounded mr-2"></span>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-secondary text-white p-4 no-print">
        <div class="container mx-auto flex justify-center space-x-4 space-x-reverse">
            <button onclick="showSection('elementary')" id="elementaryBtn" class="px-6 py-2 rounded-lg bg-primary text-white hover:bg-green-600 transition-colors">المرحلة الابتدائية</button>
            <button onclick="showSection('middle')" id="middleBtn" class="px-6 py-2 rounded-lg bg-accent text-white hover:bg-teal-600 transition-colors">المرحلة المتوسطة</button>
            <button onclick="showSection('admin')" id="adminBtn" class="px-6 py-2 rounded-lg bg-gold text-dark hover:bg-yellow-600 transition-colors">لوحة المدير</button>
        </div>
    </nav>

    <!-- Elementary Section -->
    <div id="elementarySection" class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-primary mb-6 text-center">خريطة نواتج التعلم - المرحلة الابتدائية</h2>
            
            <!-- Basic Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-dark font-semibold mb-2">المادة</label>
                    <select id="elementary-subject" class="w-full p-3 border border-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">اختر المادة</option>
                        <option value="اللغة العربية">اللغة العربية</option>
                        <option value="الرياضيات">الرياضيات</option>
                        <option value="العلوم">العلوم</option>
                        <option value="التربية الإسلامية">التربية الإسلامية</option>
                        <option value="التربية الاجتماعية">التربية الاجتماعية</option>
                    </select>
                </div>
                <div>
                    <label class="block text-dark font-semibold mb-2">الصف</label>
                    <select id="elementary-grade" class="w-full p-3 border border-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">اختر الصف</option>
                        <option value="الأول">الأول</option>
                        <option value="الثاني">الثاني</option>
                        <option value="الثالث">الثالث</option>
                        <option value="الرابع">الرابع</option>
                        <option value="الخامس">الخامس</option>
                        <option value="السادس">السادس</option>
                    </select>
                </div>
                <div>
                    <label class="block text-dark font-semibold mb-2">الفصل الدراسي</label>
                    <select id="elementary-semester" class="w-full p-3 border border-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">اختر الفصل</option>
                        <option value="الأول">الأول</option>
                        <option value="الثاني">الثاني</option>
                        <option value="الثالث">الثالث</option>
                    </select>
                </div>
                <div>
                    <label class="block text-dark font-semibold mb-2">اسم المعلم/المعلمة</label>
                    <select id="elementary-teacher" class="w-full p-3 border border-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">اختر المعلم/المعلمة</option>
                    </select>
                </div>
            </div>

            <!-- Date Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                <div>
                    <label class="block text-dark font-semibold mb-2">تاريخ إنشاء الخريطة</label>
                    <input type="date" id="elementary-creation-date" class="w-full p-3 border border-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label class="block text-dark font-semibold mb-2">تاريخ آخر تحديث</label>
                    <input type="date" id="elementary-update-date" class="w-full p-3 border border-secondary rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" readonly>
                </div>
            </div>

            <!-- Learning Map Sections -->
            <div class="space-y-6">
                <!-- Units -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-secondary mb-3">الوحدات</h3>
                    <div id="elementary-units-container">
                        <div class="flex gap-2 mb-2">
                            <input type="text" class="flex-1 p-2 border border-gray-300 rounded" placeholder="أدخل الوحدة">
                            <button onclick="addField('elementary-units-container')" class="px-4 py-2 bg-primary text-white rounded hover:bg-green-600">إضافة</button>
                        </div>
                    </div>
                </div>

                <!-- Learning Objectives -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-secondary mb-3">الأهداف التعليمية</h3>
                    <div id="elementary-objectives-container">
                        <div class="flex gap-2 mb-2">
                            <input type="text" class="flex-1 p-2 border border-gray-300 rounded" placeholder="أدخل الهدف التعليمي">
                            <button onclick="addField('elementary-objectives-container')" class="px-4 py-2 bg-primary text-white rounded hover:bg-green-600">إضافة</button>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-secondary mb-3">المحتوى</h3>
                    <div id="elementary-content-container">
                        <div class="flex gap-2 mb-2">
                            <input type="text" class="flex-1 p-2 border border-gray-300 rounded" placeholder="أدخل المحتوى">
                            <button onclick="addField('elementary-content-container')" class="px-4 py-2 bg-primary text-white rounded hover:bg-green-600">إضافة</button>
                        </div>
                    </div>
                </div>

                <!-- Learning Outcomes -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-secondary mb-3">نواتج التعلم</h3>
                    <div id="elementary-outcomes-container">
                        <div class="space-y-2 mb-2">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل ناتج التعلم">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل الشاهد">
                            <button onclick="addOutcomeField('elementary-outcomes-container')" class="px-4 py-2 bg-primary text-white rounded hover:bg-green-600">إضافة</button>
                        </div>
                    </div>
                </div>

                <!-- Educational Activities -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-secondary mb-3">الأنشطة التعليمية</h3>
                    <div id="elementary-activities-container">
                        <div class="space-y-2 mb-2">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل النشاط التعليمي">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل الشاهد">
                            <button onclick="addOutcomeField('elementary-activities-container')" class="px-4 py-2 bg-primary text-white rounded hover:bg-green-600">إضافة</button>
                        </div>
                    </div>
                </div>

                <!-- Teaching Methods -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-secondary mb-3">أساليب وطرق التدريس</h3>
                    <div id="elementary-methods-container">
                        <div class="space-y-2 mb-2">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل أسلوب التدريس">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل الشاهد">
                            <button onclick="addOutcomeField('elementary-methods-container')" class="px-4 py-2 bg-primary text-white rounded hover:bg-green-600">إضافة</button>
                        </div>
                    </div>
                </div>

                <!-- Assessment Tools -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-secondary mb-3">أساليب وأدوات تقويم نواتج التعلم</h3>
                    <div id="elementary-assessment-container">
                        <div class="space-y-2 mb-2">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل أداة التقويم">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل الشاهد">
                            <button onclick="addOutcomeField('elementary-assessment-container')" class="px-4 py-2 bg-primary text-white rounded hover:bg-green-600">إضافة</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 space-x-reverse mt-8 no-print">
                <button onclick="saveData('elementary')" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-green-600 transition-colors">حفظ البيانات</button>
                <button onclick="printSection('elementarySection')" class="px-6 py-3 bg-secondary text-white rounded-lg hover:bg-blue-600 transition-colors">طباعة</button>
                <button onclick="exportToWord('elementary')" class="px-6 py-3 bg-accent text-white rounded-lg hover:bg-teal-600 transition-colors">تصدير إلى Word</button>
            </div>
        </div>
    </div>

    <!-- Middle School Section -->
    <div id="middleSection" class="container mx-auto p-6 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-accent mb-6 text-center">خريطة نواتج التعلم - المرحلة المتوسطة</h2>
            
            <!-- Basic Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-dark font-semibold mb-2">المادة</label>
                    <select id="middle-subject" class="w-full p-3 border border-accent rounded-lg focus:outline-none focus:ring-2 focus:ring-accent">
                        <option value="">اختر المادة</option>
                        <option value="اللغة العربية">اللغة العربية</option>
                        <option value="الرياضيات">الرياضيات</option>
                        <option value="العلوم">العلوم</option>
                        <option value="التربية الإسلامية">التربية الإسلامية</option>
                        <option value="الدراسات الاجتماعية">الدراسات الاجتماعية</option>
                        <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                    </select>
                </div>
                <div>
                    <label class="block text-dark font-semibold mb-2">الصف</label>
                    <select id="middle-grade" class="w-full p-3 border border-accent rounded-lg focus:outline-none focus:ring-2 focus:ring-accent">
                        <option value="">اختر الصف</option>
                        <option value="الأول المتوسط">الأول المتوسط</option>
                        <option value="الثاني المتوسط">الثاني المتوسط</option>
                        <option value="الثالث المتوسط">الثالث المتوسط</option>
                    </select>
                </div>
                <div>
                    <label class="block text-dark font-semibold mb-2">الفصل الدراسي</label>
                    <select id="middle-semester" class="w-full p-3 border border-accent rounded-lg focus:outline-none focus:ring-2 focus:ring-accent">
                        <option value="">اختر الفصل</option>
                        <option value="الأول">الأول</option>
                        <option value="الثاني">الثاني</option>
                        <option value="الثالث">الثالث</option>
                    </select>
                </div>
                <div>
                    <label class="block text-dark font-semibold mb-2">اسم المعلم/المعلمة</label>
                    <select id="middle-teacher" class="w-full p-3 border border-accent rounded-lg focus:outline-none focus:ring-2 focus:ring-accent">
                        <option value="">اختر المعلم/المعلمة</option>
                    </select>
                </div>
            </div>

            <!-- Date Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                <div>
                    <label class="block text-dark font-semibold mb-2">تاريخ إنشاء الخريطة</label>
                    <input type="date" id="middle-creation-date" class="w-full p-3 border border-accent rounded-lg focus:outline-none focus:ring-2 focus:ring-accent">
                </div>
                <div>
                    <label class="block text-dark font-semibold mb-2">تاريخ آخر تحديث</label>
                    <input type="date" id="middle-update-date" class="w-full p-3 border border-accent rounded-lg focus:outline-none focus:ring-2 focus:ring-accent" readonly>
                </div>
            </div>

            <!-- Learning Map Sections (Similar structure as elementary) -->
            <div class="space-y-6">
                <!-- Units -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-accent mb-3">الوحدات</h3>
                    <div id="middle-units-container">
                        <div class="flex gap-2 mb-2">
                            <input type="text" class="flex-1 p-2 border border-gray-300 rounded" placeholder="أدخل الوحدة">
                            <button onclick="addField('middle-units-container')" class="px-4 py-2 bg-accent text-white rounded hover:bg-teal-600">إضافة</button>
                        </div>
                    </div>
                </div>

                <!-- Learning Objectives -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-accent mb-3">الأهداف التعليمية</h3>
                    <div id="middle-objectives-container">
                        <div class="flex gap-2 mb-2">
                            <input type="text" class="flex-1 p-2 border border-gray-300 rounded" placeholder="أدخل الهدف التعليمي">
                            <button onclick="addField('middle-objectives-container')" class="px-4 py-2 bg-accent text-white rounded hover:bg-teal-600">إضافة</button>
                        </div>
                    </div>
                </div>

                <!-- Content -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-accent mb-3">المحتوى</h3>
                    <div id="middle-content-container">
                        <div class="flex gap-2 mb-2">
                            <input type="text" class="flex-1 p-2 border border-gray-300 rounded" placeholder="أدخل المحتوى">
                            <button onclick="addField('middle-content-container')" class="px-4 py-2 bg-accent text-white rounded hover:bg-teal-600">إضافة</button>
                        </div>
                    </div>
                </div>

                <!-- Learning Outcomes -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-accent mb-3">نواتج التعلم</h3>
                    <div id="middle-outcomes-container">
                        <div class="space-y-2 mb-2">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل ناتج التعلم">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل الشاهد">
                            <button onclick="addOutcomeField('middle-outcomes-container')" class="px-4 py-2 bg-accent text-white rounded hover:bg-teal-600">إضافة</button>
                        </div>
                    </div>
                </div>

                <!-- Educational Activities -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-accent mb-3">الأنشطة التعليمية</h3>
                    <div id="middle-activities-container">
                        <div class="space-y-2 mb-2">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل النشاط التعليمي">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل الشاهد">
                            <button onclick="addOutcomeField('middle-activities-container')" class="px-4 py-2 bg-accent text-white rounded hover:bg-teal-600">إضافة</button>
                        </div>
                    </div>
                </div>

                <!-- Teaching Methods -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-accent mb-3">أساليب وطرق التدريس</h3>
                    <div id="middle-methods-container">
                        <div class="space-y-2 mb-2">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل أسلوب التدريس">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل الشاهد">
                            <button onclick="addOutcomeField('middle-methods-container')" class="px-4 py-2 bg-accent text-white rounded hover:bg-teal-600">إضافة</button>
                        </div>
                    </div>
                </div>

                <!-- Assessment Tools -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-accent mb-3">أساليب وأدوات تقويم نواتج التعلم</h3>
                    <div id="middle-assessment-container">
                        <div class="space-y-2 mb-2">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل أداة التقويم">
                            <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل الشاهد">
                            <button onclick="addOutcomeField('middle-assessment-container')" class="px-4 py-2 bg-accent text-white rounded hover:bg-teal-600">إضافة</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-center space-x-4 space-x-reverse mt-8 no-print">
                <button onclick="saveData('middle')" class="px-6 py-3 bg-accent text-white rounded-lg hover:bg-teal-600 transition-colors">حفظ البيانات</button>
                <button onclick="printSection('middleSection')" class="px-6 py-3 bg-secondary text-white rounded-lg hover:bg-blue-600 transition-colors">طباعة</button>
                <button onclick="exportToWord('middle')" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-green-600 transition-colors">تصدير إلى Word</button>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminSection" class="container mx-auto p-6 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gold mb-6 text-center">لوحة متابعة المدير</h2>
            
            <!-- Teacher Management Section -->
            <div class="bg-gray-50 p-6 rounded-lg mb-8">
                <h3 class="text-xl font-bold text-dark mb-4">إدارة المعلمين والمعلمات</h3>
                
                <!-- Import Instructions -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="text-lg font-semibold text-blue-800 mb-2">📋 تعليمات الاستيراد من Excel</h4>
                    <div class="text-sm text-blue-700 space-y-1">
                        <p>• اضغط على "تحميل نموذج Excel" للحصول على الملف النموذجي</p>
                        <p>• املأ البيانات في الأعمدة: الاسم، التخصص، المرحلة</p>
                        <p>• احفظ الملف بصيغة Excel (.xlsx أو .xls)</p>
                        <p>• اضغط على "استيراد من Excel" واختر الملف</p>
                        <p>• سيتم تجاهل المعلمين الموجودين مسبقاً تلقائياً</p>
                    </div>
                </div>
                
                <!-- Add Teacher Form -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-dark font-semibold mb-2">اسم المعلم/المعلمة</label>
                        <input type="text" id="teacher-name" class="w-full p-3 border border-gold rounded-lg focus:outline-none focus:ring-2 focus:ring-gold" placeholder="أدخل اسم المعلم/المعلمة">
                    </div>
                    <div>
                        <label class="block text-dark font-semibold mb-2">التخصص</label>
                        <select id="teacher-subject" class="w-full p-3 border border-gold rounded-lg focus:outline-none focus:ring-2 focus:ring-gold">
                            <option value="">اختر التخصص</option>
                            <option value="اللغة العربية">اللغة العربية</option>
                            <option value="الرياضيات">الرياضيات</option>
                            <option value="العلوم">العلوم</option>
                            <option value="التربية الإسلامية">التربية الإسلامية</option>
                            <option value="التربية الاجتماعية">التربية الاجتماعية</option>
                            <option value="الدراسات الاجتماعية">الدراسات الاجتماعية</option>
                            <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-dark font-semibold mb-2">المرحلة</label>
                        <select id="teacher-stage" class="w-full p-3 border border-gold rounded-lg focus:outline-none focus:ring-2 focus:ring-gold">
                            <option value="">اختر المرحلة</option>
                            <option value="ابتدائية">ابتدائية</option>
                            <option value="متوسطة">متوسطة</option>
                            <option value="ابتدائية ومتوسطة">ابتدائية ومتوسطة</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-center space-x-4 space-x-reverse mb-4">
                    <button onclick="addTeacher()" class="px-6 py-3 bg-gold text-dark rounded-lg hover:bg-yellow-600 hover:text-white transition-colors font-semibold">إضافة المعلم/المعلمة</button>
                    <div class="relative">
                        <input type="file" id="excel-file" accept=".xlsx,.xls" class="hidden" onchange="importFromExcel(event)">
                        <button onclick="document.getElementById('excel-file').click()" class="px-6 py-3 bg-secondary text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold">استيراد من Excel</button>
                    </div>
                    <button onclick="downloadTemplate()" class="px-6 py-3 bg-accent text-white rounded-lg hover:bg-teal-600 transition-colors font-semibold">تحميل نموذج Excel</button>
                </div>

                <!-- Teachers List -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-dark text-white">
                                <th class="border border-gray-300 p-3">الاسم</th>
                                <th class="border border-gray-300 p-3">التخصص</th>
                                <th class="border border-gray-300 p-3">المرحلة</th>
                                <th class="border border-gray-300 p-3">تاريخ الإضافة</th>
                                <th class="border border-gray-300 p-3">المصدر</th>
                                <th class="border border-gray-300 p-3">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="teachersTable">
                            <tr>
                                <td colspan="6" class="border border-gray-300 p-4 text-center text-gray-500">لا يوجد معلمين مضافين</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Progress Overview -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-gradient-to-r from-primary to-secondary p-6 rounded-lg text-white">
                    <h3 class="text-xl font-bold mb-4">المرحلة الابتدائية</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>الخرائط المكتملة:</span>
                            <span id="elementary-completed">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>الخرائط قيد الإنجاز:</span>
                            <span id="elementary-progress">0</span>
                        </div>
                        <div class="w-full bg-white bg-opacity-30 rounded-full h-2">
                            <div id="elementary-progress-bar" class="bg-white h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-accent to-secondary p-6 rounded-lg text-white">
                    <h3 class="text-xl font-bold mb-4">المرحلة المتوسطة</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>الخرائط المكتملة:</span>
                            <span id="middle-completed">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>الخرائط قيد الإنجاز:</span>
                            <span id="middle-progress">0</span>
                        </div>
                        <div class="w-full bg-white bg-opacity-30 rounded-full h-2">
                            <div id="middle-progress-bar" class="bg-white h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-dark mb-4 text-center">نسبة الإنجاز حسب المرحلة</h3>
                    <canvas id="stageChart" width="400" height="200"></canvas>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-bold text-dark mb-4 text-center">نسبة الإنجاز حسب المادة</h3>
                    <canvas id="subjectChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Detailed Reports -->
            <div class="bg-gray-50 p-6 rounded-lg">
                <h3 class="text-xl font-bold text-dark mb-4">تقارير مفصلة</h3>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-dark text-white">
                                <th class="border border-gray-300 p-3">المرحلة</th>
                                <th class="border border-gray-300 p-3">المادة</th>
                                <th class="border border-gray-300 p-3">الصف</th>
                                <th class="border border-gray-300 p-3">المعلم/المعلمة</th>
                                <th class="border border-gray-300 p-3">تاريخ الإنشاء</th>
                                <th class="border border-gray-300 p-3">آخر تحديث</th>
                                <th class="border border-gray-300 p-3">نسبة الإنجاز</th>
                                <th class="border border-gray-300 p-3">الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTable">
                            <tr>
                                <td colspan="8" class="border border-gray-300 p-4 text-center text-gray-500">لا توجد بيانات متاحة</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Export Options -->
            <div class="flex justify-center space-x-4 space-x-reverse mt-8 no-print">
                <button onclick="exportAllReports()" class="px-6 py-3 bg-gold text-dark rounded-lg hover:bg-yellow-600 hover:text-white transition-colors">تصدير جميع التقارير</button>
                <button onclick="printSection('adminSection')" class="px-6 py-3 bg-secondary text-white rounded-lg hover:bg-blue-600 transition-colors">طباعة التقرير</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white p-4 mt-8">
        <div class="container mx-auto text-center">
            <p class="text-lg">مدير المدرسة: عبدالرحمن السهلي</p>
            <p class="text-sm mt-2">مدرسة ابتدائية ومتوسطة الصوارمة - جازان</p>
        </div>
    </footer>

    <script>
        // Global variables
        let elementaryData = JSON.parse(localStorage.getItem('elementaryData')) || [];
        let middleData = JSON.parse(localStorage.getItem('middleData')) || [];
        let teachersData = JSON.parse(localStorage.getItem('teachersData')) || [];
        
        // Initialize charts
        let stageChart, subjectChart;

        // Update date and time
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                calendar: 'islamic-umalqura'
            };
            const timeOptions = { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: true
            };
            
            document.getElementById('current-date').textContent = now.toLocaleDateString('ar-SA', dateOptions);
            document.getElementById('current-time').textContent = now.toLocaleTimeString('ar-SA', timeOptions);
        }

        // Set current date in date inputs
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('elementary-creation-date').value = today;
            document.getElementById('middle-creation-date').value = today;
        }

        // Show/Hide sections
        function showSection(section) {
            // Hide all sections
            document.getElementById('elementarySection').classList.add('hidden');
            document.getElementById('middleSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            
            // Remove active class from all buttons
            document.getElementById('elementaryBtn').classList.remove('bg-primary');
            document.getElementById('middleBtn').classList.remove('bg-primary');
            document.getElementById('adminBtn').classList.remove('bg-primary');
            
            // Show selected section and activate button
            if (section === 'elementary') {
                document.getElementById('elementarySection').classList.remove('hidden');
                document.getElementById('elementaryBtn').classList.add('bg-primary');
            } else if (section === 'middle') {
                document.getElementById('middleSection').classList.remove('hidden');
                document.getElementById('middleBtn').classList.add('bg-primary');
            } else if (section === 'admin') {
                document.getElementById('adminSection').classList.remove('hidden');
                document.getElementById('adminBtn').classList.add('bg-primary');
                updateAdminDashboard();
            }
        }

        // Excel Import Functions
        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    processExcelData(jsonData);
                } catch (error) {
                    alert('خطأ في قراءة الملف. تأكد من أن الملف بصيغة Excel صحيحة.');
                    console.error('Excel import error:', error);
                }
            };
            reader.readAsArrayBuffer(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        function processExcelData(data) {
            if (!data || data.length === 0) {
                alert('الملف فارغ أو لا يحتوي على بيانات صحيحة');
                return;
            }
            
            let importedCount = 0;
            let skippedCount = 0;
            let errors = [];
            
            data.forEach((row, index) => {
                try {
                    // Check for required columns (flexible column names)
                    const name = row['الاسم'] || row['اسم المعلم'] || row['المعلم'] || row['Name'] || '';
                    const subject = row['التخصص'] || row['المادة'] || row['Subject'] || '';
                    const stage = row['المرحلة'] || row['Stage'] || '';
                    
                    if (!name.trim()) {
                        errors.push(`الصف ${index + 2}: اسم المعلم مطلوب`);
                        return;
                    }
                    
                    if (!subject.trim()) {
                        errors.push(`الصف ${index + 2}: التخصص مطلوب`);
                        return;
                    }
                    
                    if (!stage.trim()) {
                        errors.push(`الصف ${index + 2}: المرحلة مطلوبة`);
                        return;
                    }
                    
                    // Validate stage values
                    const validStages = ['ابتدائية', 'متوسطة', 'ابتدائية ومتوسطة'];
                    if (!validStages.includes(stage.trim())) {
                        errors.push(`الصف ${index + 2}: المرحلة يجب أن تكون إحدى القيم: ${validStages.join(', ')}`);
                        return;
                    }
                    
                    // Check if teacher already exists
                    if (teachersData.some(teacher => teacher.name.toLowerCase() === name.trim().toLowerCase())) {
                        skippedCount++;
                        return;
                    }
                    
                    // Add teacher
                    const teacher = {
                        id: Date.now() + Math.random(),
                        name: name.trim(),
                        subject: subject.trim(),
                        stage: stage.trim(),
                        dateAdded: new Date().toISOString(),
                        importedFromExcel: true
                    };
                    
                    teachersData.push(teacher);
                    importedCount++;
                    
                } catch (error) {
                    errors.push(`الصف ${index + 2}: خطأ في معالجة البيانات`);
                }
            });
            
            // Save to localStorage
            localStorage.setItem('teachersData', JSON.stringify(teachersData));
            
            // Update UI
            updateTeachersTable();
            updateTeacherDropdowns();
            
            // Show results
            let message = `تم استيراد ${importedCount} معلم/معلمة بنجاح`;
            if (skippedCount > 0) {
                message += `\nتم تخطي ${skippedCount} معلم/معلمة (موجود مسبقاً)`;
            }
            if (errors.length > 0) {
                message += `\n\nأخطاء:\n${errors.slice(0, 5).join('\n')}`;
                if (errors.length > 5) {
                    message += `\n... و ${errors.length - 5} أخطاء أخرى`;
                }
            }
            
            alert(message);
        }
        
        function downloadTemplate() {
            // Create template data
            const templateData = [
                {
                    'الاسم': 'أحمد محمد السعيد',
                    'التخصص': 'اللغة العربية',
                    'المرحلة': 'ابتدائية'
                },
                {
                    'الاسم': 'فاطمة علي أحمد',
                    'التخصص': 'الرياضيات',
                    'المرحلة': 'متوسطة'
                },
                {
                    'الاسم': 'محمد عبدالله حسن',
                    'التخصص': 'العلوم',
                    'المرحلة': 'ابتدائية ومتوسطة'
                }
            ];
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(templateData);
            
            // Set column widths
            ws['!cols'] = [
                { width: 25 }, // الاسم
                { width: 20 }, // التخصص
                { width: 20 }  // المرحلة
            ];
            
            // Add instructions sheet
            const instructions = [
                { 'التعليمات': 'يرجى ملء البيانات في الأعمدة التالية:' },
                { 'التعليمات': '1. الاسم: اسم المعلم/المعلمة كاملاً' },
                { 'التعليمات': '2. التخصص: المادة التي يدرسها' },
                { 'التعليمات': '3. المرحلة: ابتدائية أو متوسطة أو ابتدائية ومتوسطة' },
                { 'التعليمات': '' },
                { 'التعليمات': 'التخصصات المتاحة:' },
                { 'التعليمات': '- اللغة العربية' },
                { 'التعليمات': '- الرياضيات' },
                { 'التعليمات': '- العلوم' },
                { 'التعليمات': '- التربية الإسلامية' },
                { 'التعليمات': '- التربية الاجتماعية' },
                { 'التعليمات': '- الدراسات الاجتماعية' },
                { 'التعليمات': '- اللغة الإنجليزية' },
                { 'التعليمات': '' },
                { 'التعليمات': 'المراحل المتاحة:' },
                { 'التعليمات': '- ابتدائية' },
                { 'التعليمات': '- متوسطة' },
                { 'التعليمات': '- ابتدائية ومتوسطة' }
            ];
            
            const wsInstructions = XLSX.utils.json_to_sheet(instructions);
            wsInstructions['!cols'] = [{ width: 50 }];
            
            // Add sheets to workbook
            XLSX.utils.book_append_sheet(wb, wsInstructions, 'التعليمات');
            XLSX.utils.book_append_sheet(wb, ws, 'بيانات المعلمين');
            
            // Download file
            XLSX.writeFile(wb, 'نموذج_بيانات_المعلمين.xlsx');
        }

        // Teacher Management Functions
        function addTeacher() {
            const name = document.getElementById('teacher-name').value.trim();
            const subject = document.getElementById('teacher-subject').value;
            const stage = document.getElementById('teacher-stage').value;
            
            if (!name || !subject || !stage) {
                alert('يرجى إكمال جميع البيانات');
                return;
            }
            
            // Check if teacher already exists
            if (teachersData.some(teacher => teacher.name === name)) {
                alert('هذا المعلم/المعلمة موجود بالفعل');
                return;
            }
            
            const teacher = {
                id: Date.now(),
                name: name,
                subject: subject,
                stage: stage,
                dateAdded: new Date().toISOString()
            };
            
            teachersData.push(teacher);
            localStorage.setItem('teachersData', JSON.stringify(teachersData));
            
            // Clear form
            document.getElementById('teacher-name').value = '';
            document.getElementById('teacher-subject').value = '';
            document.getElementById('teacher-stage').value = '';
            
            updateTeachersTable();
            updateTeacherDropdowns();
            alert('تم إضافة المعلم/المعلمة بنجاح');
        }

        function deleteTeacher(id) {
            if (confirm('هل أنت متأكد من حذف هذا المعلم/المعلمة؟')) {
                teachersData = teachersData.filter(teacher => teacher.id !== id);
                localStorage.setItem('teachersData', JSON.stringify(teachersData));
                updateTeachersTable();
                updateTeacherDropdowns();
            }
        }

        function updateTeachersTable() {
            const tbody = document.getElementById('teachersTable');
            
            if (teachersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="border border-gray-300 p-4 text-center text-gray-500">لا يوجد معلمين مضافين</td></tr>';
                return;
            }
            
            tbody.innerHTML = teachersData.map(teacher => `
                <tr>
                    <td class="border border-gray-300 p-3">${teacher.name}</td>
                    <td class="border border-gray-300 p-3">${teacher.subject}</td>
                    <td class="border border-gray-300 p-3">${teacher.stage}</td>
                    <td class="border border-gray-300 p-3">${new Date(teacher.dateAdded).toLocaleDateString('ar-SA')}</td>
                    <td class="border border-gray-300 p-3">
                        <span class="px-2 py-1 rounded text-xs ${teacher.importedFromExcel ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            ${teacher.importedFromExcel ? 'Excel' : 'يدوي'}
                        </span>
                    </td>
                    <td class="border border-gray-300 p-3">
                        <button onclick="deleteTeacher(${teacher.id})" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">حذف</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateTeacherDropdowns() {
            const elementarySelect = document.getElementById('elementary-teacher');
            const middleSelect = document.getElementById('middle-teacher');
            
            // Clear existing options except first
            elementarySelect.innerHTML = '<option value="">اختر المعلم/المعلمة</option>';
            middleSelect.innerHTML = '<option value="">اختر المعلم/المعلمة</option>';
            
            // Add teachers to appropriate dropdowns
            teachersData.forEach(teacher => {
                if (teacher.stage === 'ابتدائية' || teacher.stage === 'ابتدائية ومتوسطة') {
                    elementarySelect.innerHTML += `<option value="${teacher.name}">${teacher.name} - ${teacher.subject}</option>`;
                }
                if (teacher.stage === 'متوسطة' || teacher.stage === 'ابتدائية ومتوسطة') {
                    middleSelect.innerHTML += `<option value="${teacher.name}">${teacher.name} - ${teacher.subject}</option>`;
                }
            });
        }

        // Add field functionality
        function addField(containerId) {
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('input');
            
            if (inputs.length >= 10) {
                alert('يمكن إضافة 10 عناصر كحد أقصى');
                return;
            }
            
            const newField = document.createElement('div');
            newField.className = 'flex gap-2 mb-2';
            newField.innerHTML = `
                <input type="text" class="flex-1 p-2 border border-gray-300 rounded" placeholder="أدخل البيانات">
                <button onclick="removeField(this)" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">حذف</button>
            `;
            
            container.appendChild(newField);
        }

        // Add outcome field with evidence
        function addOutcomeField(containerId) {
            const container = document.getElementById(containerId);
            const fieldGroups = container.querySelectorAll('.space-y-2');
            
            if (fieldGroups.length >= 10) {
                alert('يمكن إضافة 10 عناصر كحد أقصى');
                return;
            }
            
            const newField = document.createElement('div');
            newField.className = 'space-y-2 mb-2 p-3 border border-gray-200 rounded';
            newField.innerHTML = `
                <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل البيانات">
                <input type="text" class="w-full p-2 border border-gray-300 rounded" placeholder="أدخل الشاهد">
                <button onclick="removeField(this.parentElement)" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">حذف</button>
            `;
            
            container.appendChild(newField);
        }

        // Remove field
        function removeField(element) {
            element.remove();
        }

        // Save data
        function saveData(stage) {
            const data = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                subject: document.getElementById(`${stage}-subject`).value,
                grade: document.getElementById(`${stage}-grade`).value,
                semester: document.getElementById(`${stage}-semester`).value,
                teacher: document.getElementById(`${stage}-teacher`).value,
                creationDate: document.getElementById(`${stage}-creation-date`).value,
                updateDate: new Date().toISOString().split('T')[0],
                units: getFieldValues(`${stage}-units-container`),
                objectives: getFieldValues(`${stage}-objectives-container`),
                content: getFieldValues(`${stage}-content-container`),
                outcomes: getOutcomeValues(`${stage}-outcomes-container`),
                activities: getOutcomeValues(`${stage}-activities-container`),
                methods: getOutcomeValues(`${stage}-methods-container`),
                assessment: getOutcomeValues(`${stage}-assessment-container`)
            };

            // Update the update date field
            document.getElementById(`${stage}-update-date`).value = data.updateDate;

            if (stage === 'elementary') {
                elementaryData.push(data);
                localStorage.setItem('elementaryData', JSON.stringify(elementaryData));
            } else {
                middleData.push(data);
                localStorage.setItem('middleData', JSON.stringify(middleData));
            }

            alert('تم حفظ البيانات بنجاح!');
            clearForm(stage);
        }

        // Get field values
        function getFieldValues(containerId) {
            const container = document.getElementById(containerId);
            const inputs = container.querySelectorAll('input[type="text"]');
            return Array.from(inputs).map(input => input.value).filter(value => value.trim() !== '');
        }

        // Get outcome values with evidence
        function getOutcomeValues(containerId) {
            const container = document.getElementById(containerId);
            const fieldGroups = container.querySelectorAll('.space-y-2');
            const results = [];
            
            fieldGroups.forEach(group => {
                const inputs = group.querySelectorAll('input[type="text"]');
                if (inputs.length >= 2 && inputs[0].value.trim() !== '') {
                    results.push({
                        content: inputs[0].value,
                        evidence: inputs[1].value
                    });
                }
            });
            
            return results;
        }

        // Clear form
        function clearForm(stage) {
            document.getElementById(`${stage}-subject`).value = '';
            document.getElementById(`${stage}-grade`).value = '';
            document.getElementById(`${stage}-semester`).value = '';
            document.getElementById(`${stage}-teacher`).value = '';
            
            // Reset dates
            setCurrentDate();
            document.getElementById(`${stage}-update-date`).value = '';
            
            // Clear all dynamic fields
            const containers = [
                `${stage}-units-container`,
                `${stage}-objectives-container`,
                `${stage}-content-container`,
                `${stage}-outcomes-container`,
                `${stage}-activities-container`,
                `${stage}-methods-container`,
                `${stage}-assessment-container`
            ];
            
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                const dynamicFields = container.querySelectorAll('.flex, .space-y-2');
                dynamicFields.forEach((field, index) => {
                    if (index > 0) field.remove();
                });
                
                // Clear first field
                const inputs = container.querySelectorAll('input[type="text"]');
                inputs.forEach(input => input.value = '');
            });
        }

        // Print section
        function printSection(sectionId) {
            const section = document.getElementById(sectionId);
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>طباعة</title>
                    <style>
                        body { font-family: 'Tajawal', Arial, sans-serif; direction: rtl; }
                        .no-print { display: none !important; }
                        @media print { body { background: white !important; } }
                    </style>
                </head>
                <body>
                    ${section.innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Export to Word
        function exportToWord(stage) {
            const data = stage === 'elementary' ? elementaryData : middleData;
            if (data.length === 0) {
                alert('لا توجد بيانات للتصدير');
                return;
            }
            
            let content = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid black; padding: 8px; text-align: right; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>تقرير خريطة نواتج التعلم - ${stage === 'elementary' ? 'المرحلة الابتدائية' : 'المرحلة المتوسطة'}</h1>
                    <p>مدرسة ابتدائية ومتوسطة الصوارمة - جازان</p>
                    <p>مدير المدرسة: عبدالرحمن السهلي</p>
                    <p>تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
            `;
            
            data.forEach((item, index) => {
                content += `
                    <h2>خريطة رقم ${index + 1}</h2>
                    <table>
                        <tr><th>المادة</th><td>${item.subject}</td></tr>
                        <tr><th>الصف</th><td>${item.grade}</td></tr>
                        <tr><th>الفصل الدراسي</th><td>${item.semester}</td></tr>
                        <tr><th>المعلم/المعلمة</th><td>${item.teacher}</td></tr>
                        <tr><th>تاريخ الإنشاء</th><td>${item.creationDate}</td></tr>
                        <tr><th>آخر تحديث</th><td>${item.updateDate}</td></tr>
                        <tr><th>الوحدات</th><td>${item.units.join(', ')}</td></tr>
                        <tr><th>الأهداف التعليمية</th><td>${item.objectives.join(', ')}</td></tr>
                        <tr><th>المحتوى</th><td>${item.content.join(', ')}</td></tr>
                    </table>
                    <br>
                `;
            });
            
            content += '</body></html>';
            
            const blob = new Blob([content], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `خريطة_نواتج_التعلم_${stage}.doc`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Update admin dashboard
        function updateAdminDashboard() {
            updateTeachersTable();
            
            // Calculate completion rates
            const elementaryCompleted = calculateCompletionRate(elementaryData);
            const middleCompleted = calculateCompletionRate(middleData);
            
            // Update progress displays
            document.getElementById('elementary-completed').textContent = elementaryCompleted.completed;
            document.getElementById('elementary-progress').textContent = elementaryCompleted.total - elementaryCompleted.completed;
            document.getElementById('elementary-progress-bar').style.width = `${elementaryCompleted.percentage}%`;
            
            document.getElementById('middle-completed').textContent = middleCompleted.completed;
            document.getElementById('middle-progress').textContent = middleCompleted.total - middleCompleted.completed;
            document.getElementById('middle-progress-bar').style.width = `${middleCompleted.percentage}%`;
            
            // Update charts
            updateCharts();
            
            // Update reports table
            updateReportsTable();
        }

        // Calculate completion rate
        function calculateCompletionRate(data) {
            const total = data.length;
            const completed = data.filter(item => {
                return item.units.length > 0 && 
                       item.objectives.length > 0 && 
                       item.content.length > 0 && 
                       item.outcomes.length > 0 && 
                       item.activities.length > 0 && 
                       item.methods.length > 0 && 
                       item.assessment.length > 0;
            }).length;
            
            return {
                total,
                completed,
                percentage: total > 0 ? Math.round((completed / total) * 100) : 0
            };
        }

        // Update charts
        function updateCharts() {
            const ctx1 = document.getElementById('stageChart').getContext('2d');
            const ctx2 = document.getElementById('subjectChart').getContext('2d');
            
            // Destroy existing charts
            if (stageChart) stageChart.destroy();
            if (subjectChart) subjectChart.destroy();
            
            // Stage completion chart
            const elementaryRate = calculateCompletionRate(elementaryData);
            const middleRate = calculateCompletionRate(middleData);
            
            stageChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['المرحلة الابتدائية', 'المرحلة المتوسطة'],
                    datasets: [{
                        data: [elementaryRate.percentage, middleRate.percentage],
                        backgroundColor: ['#07A869', '#0DA9A6']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Subject completion chart
            const subjectData = getSubjectCompletionData();
            
            subjectChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(subjectData),
                    datasets: [{
                        label: 'نسبة الإنجاز %',
                        data: Object.values(subjectData),
                        backgroundColor: '#3D7EB9'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Get subject completion data
        function getSubjectCompletionData() {
            const allData = [...elementaryData, ...middleData];
            const subjects = {};
            
            allData.forEach(item => {
                if (!subjects[item.subject]) {
                    subjects[item.subject] = { total: 0, completed: 0 };
                }
                subjects[item.subject].total++;
                
                if (item.units.length > 0 && item.objectives.length > 0 && 
                    item.content.length > 0 && item.outcomes.length > 0) {
                    subjects[item.subject].completed++;
                }
            });
            
            const result = {};
            Object.keys(subjects).forEach(subject => {
                const data = subjects[subject];
                result[subject] = data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0;
            });
            
            return result;
        }

        // Update reports table
        function updateReportsTable() {
            const tbody = document.getElementById('reportsTable');
            const allData = [
                ...elementaryData.map(item => ({ ...item, stage: 'الابتدائية' })),
                ...middleData.map(item => ({ ...item, stage: 'المتوسطة' }))
            ];
            
            if (allData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="border border-gray-300 p-4 text-center text-gray-500">لا توجد بيانات متاحة</td></tr>';
                return;
            }
            
            tbody.innerHTML = allData.map(item => {
                const completionRate = calculateItemCompletion(item);
                const status = completionRate === 100 ? 'مكتملة' : 'قيد الإنجاز';
                const statusClass = completionRate === 100 ? 'text-green-600' : 'text-yellow-600';
                
                return `
                    <tr>
                        <td class="border border-gray-300 p-3">${item.stage}</td>
                        <td class="border border-gray-300 p-3">${item.subject}</td>
                        <td class="border border-gray-300 p-3">${item.grade}</td>
                        <td class="border border-gray-300 p-3">${item.teacher}</td>
                        <td class="border border-gray-300 p-3">${item.creationDate || 'غير محدد'}</td>
                        <td class="border border-gray-300 p-3">${item.updateDate || 'غير محدد'}</td>
                        <td class="border border-gray-300 p-3">${completionRate}%</td>
                        <td class="border border-gray-300 p-3 ${statusClass}">${status}</td>
                    </tr>
                `;
            }).join('');
        }

        // Calculate item completion
        function calculateItemCompletion(item) {
            const fields = ['units', 'objectives', 'content', 'outcomes', 'activities', 'methods', 'assessment'];
            const completedFields = fields.filter(field => item[field] && item[field].length > 0).length;
            return Math.round((completedFields / fields.length) * 100);
        }

        // Export all reports
        function exportAllReports() {
            const allData = [
                ...elementaryData.map(item => ({ ...item, stage: 'الابتدائية' })),
                ...middleData.map(item => ({ ...item, stage: 'المتوسطة' }))
            ];
            
            if (allData.length === 0) {
                alert('لا توجد بيانات للتصدير');
                return;
            }
            
            let content = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; }
                        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                        th, td { border: 1px solid black; padding: 8px; text-align: right; }
                        th { background-color: #f2f2f2; }
                        h1, h2 { color: #15445A; }
                    </style>
                </head>
                <body>
                    <h1>تقرير شامل لخرائط نواتج التعلم</h1>
                    <p>مدرسة ابتدائية ومتوسطة الصوارمة - جازان</p>
                    <p>مدير المدرسة: عبدالرحمن السهلي</p>
                    <p>تاريخ التقرير: ${new Date().toLocaleDateString('ar-SA')}</p>
                    
                    <h2>ملخص الإنجاز</h2>
                    <table>
                        <tr><th>المرحلة</th><th>عدد الخرائط</th><th>المكتملة</th><th>قيد الإنجاز</th><th>نسبة الإنجاز</th></tr>
            `;
            
            const elementaryStats = calculateCompletionRate(elementaryData);
            const middleStats = calculateCompletionRate(middleData);
            
            content += `
                        <tr>
                            <td>الابتدائية</td>
                            <td>${elementaryStats.total}</td>
                            <td>${elementaryStats.completed}</td>
                            <td>${elementaryStats.total - elementaryStats.completed}</td>
                            <td>${elementaryStats.percentage}%</td>
                        </tr>
                        <tr>
                            <td>المتوسطة</td>
                            <td>${middleStats.total}</td>
                            <td>${middleStats.completed}</td>
                            <td>${middleStats.total - middleStats.completed}</td>
                            <td>${middleStats.percentage}%</td>
                        </tr>
                    </table>
                    
                    <h2>تفاصيل الخرائط</h2>
                    <table>
                        <tr>
                            <th>المرحلة</th><th>المادة</th><th>الصف</th><th>المعلم/المعلمة</th>
                            <th>تاريخ الإنشاء</th><th>آخر تحديث</th><th>نسبة الإنجاز</th><th>الحالة</th>
                        </tr>
            `;
            
            allData.forEach(item => {
                const completionRate = calculateItemCompletion(item);
                const status = completionRate === 100 ? 'مكتملة' : 'قيد الإنجاز';
                
                content += `
                    <tr>
                        <td>${item.stage}</td>
                        <td>${item.subject}</td>
                        <td>${item.grade}</td>
                        <td>${item.teacher}</td>
                        <td>${item.creationDate || 'غير محدد'}</td>
                        <td>${item.updateDate || 'غير محدد'}</td>
                        <td>${completionRate}%</td>
                        <td>${status}</td>
                    </tr>
                `;
            });
            
            content += '</table></body></html>';
            
            const blob = new Blob([content], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'تقرير_شامل_خرائط_نواتج_التعلم.doc';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000); // Update every second
            setCurrentDate();
            updateTeacherDropdowns();
            showSection('elementary');
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96fb835621de520b',t:'MTc1NTI5MDQ4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
